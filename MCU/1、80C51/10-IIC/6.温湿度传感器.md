## 1、<span style="color:brown">芯片说明：</span>

**1.1、引脚&外围说明：**

<img src="https://raw.githubusercontent.com/root-bine/image/main/Typora-image/TEorHU01.png" alt="image-20251028160220040" style="zoom: 67%;" />

参照板卡原理图：**`ADDR`接`GND`**，因此`I2C`的`write / read address`为：

```c
// addr=0x44时, 实际发送到总线的数据应该是0x44+读写标志位: 0 -> write, 1 -> read
#define    GXHT3L_ADDR_WRITE    (0x44<<1)+0     //1000 1000
#define    GXHT3L_ADDR_READ     (0x44<<1)+1     //1000 1001
```

**1.2、温湿度转换公式：**

<img src="https://raw.githubusercontent.com/root-bine/image/main/Typora-image/TEorHU02.png" alt="image-20251028160705843" style="zoom:50%;" />

在**单次/周期转换模式**中，通过获取`Temperature MSB + Temperature LSB`、`Humidity MSB + Humanity LSB`，分别**合并两个8bit的数据**为**一个16bit的数据**，再带入公式进行数据转换。

**1.3、模式对比：**

|      对比项      |                       **周期转换模式**                       |                       **单次转换模式**                       |
| :--------------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
| **命令发送方式** | MCU <span style="color:red">只在初始化时发送一次</span> `0x21 0x30` | MCU <span style="color:red">每次测量前都重新发送</span> `0x24 0x00` |
|  **主机的行为**  |                       只负责“定时读取”                       |                每次先“触发测量”，再“读取结果”                |
|     **功耗**     |                芯片内部 ADC 持续运行，功耗高                 |              芯片平时休眠，仅测量时唤醒，功耗低              |
|   **响应延迟**   |                    几乎无延迟（随时可读）                    |              有延迟（需等待 10~15ms 转换完成）               |



## 2、<span style="color:brown">单次转换模式：</span>

**2.1、时序图：**

<img src="https://raw.githubusercontent.com/root-bine/image/main/Typora-image/TEorHU03.png" alt="image-20251028154552497" style="zoom:50%;" />

图中**标注2**是由**标注1**中的`MSB+LSB`决定，关于`MSB`、`LSB`解释如下：

<img src="https://raw.githubusercontent.com/root-bine/image/main/Typora-image/TEorHU04.png" alt="image-20251028155112007" style="zoom: 67%;" />

**2.2、工程代码：**

> `unsigned char buff[6]` 改成 `char buff[6]`（有符号型）后，**参与运算时会被符号扩展，导致计算出的温湿度数据错误** 

```c
#include <REGX52.H>
#include <stdio.h>
sbit scl = P0 ^ 2;
sbit sda = P0 ^ 1;
#define GXHT3L_ADDR_WRITE  ((0x44<<1) + 0)
#define GXHT3L_ADDR_READ   ((0x44<<1) + 1)
// ================= 延时函数 =================
void Delay10ms(void);
// ================= I2C 基本时序 =================
void i2c_start();
void i2c_stop();
void i2c_write_byte(unsigned char wdata);
unsigned char i2c_read_byte();
unsigned char i2c_wait_ack();
void i2c_ack();
void i2c_nack();
// ================= UART + printf重写 =================
void init_uart() {
	SCON = 0x50;
	TMOD &= 0x0F;
	TMOD |= 0x20;
	TL1 = 0xFD;
	TH1 = 0xFD;
	PCON &= 0x7F;
	TR1 = 1;
}
char putchar(char dat) {
	SBUF = dat;
	while(TI == 0);
	TI = 0;
	return dat;
}
// ================= GXHT3L 单次转换测量 =================
// --- Step 1: 设置转换模式 ---
void init_gxht3l() {
	i2c_start();
	i2c_write_byte(GXHT3L_ADDR_WRITE);
	i2c_wait_ack();
	i2c_write_byte(0x24);
	i2c_wait_ack();
	i2c_write_byte(0x00);
	i2c_wait_ack();
	i2c_stop();
	Delay10ms(); // 等待数据转换完成
}
// --- Step 2: 读取数据并转换 ---
void gxht3l_single_shot(float *temperature, float *humidity) {
	unsigned char buff[6];
	unsigned char i;
	int T, H;
	i2c_start();
	i2c_write_byte(GXHT3L_ADDR_READ);
	i2c_wait_ack();
	for(i=0; i<6; i++) {
		buff[i] = i2c_read_byte();
		if(i == 5) {
			i2c_nack();
		} else {
			i2c_ack();
		}
	}
	i2c_stop();
	T = (buff[0] << 8) | buff[1];
	H = (buff[3] << 8) | buff[4];
	*temperature = -45.0 + 175.0 * ((float)T / 65535.0);
    *humidity = 100.0 * ((float)H / 65535.0);
}
// ================= 主函数 =================
void main() {
	float T, H;
	init_uart();
	while(1) {
		init_gxht3l();
		gxht3l_single_shot(&T, &H);
		printf("T=%.2fC, H=%.2f%%\r\n", T, H);
		Delay10ms();
	}
}
```



## 3、<span style="color:brown">周期转换模式：</span>

**3.1、时序图：**

<img src="https://raw.githubusercontent.com/root-bine/image/main/Typora-image/TEorHU05.png" alt="image-20251028171247549" style="zoom: 67%;" />

图中**标注2**需要设置**两次**：

1. 设置**转换模式**；
2. 开启**周期测量模式**：`MSB + LSB = 0xE0 + 0x00`；

**3.2、转换模式表：**

在**周期转换模式**下，`clock  stretching`**不能开启**，《周期转换频率和重复率对照表》如下：

<img src="https://raw.githubusercontent.com/root-bine/image/main/Typora-image/TEorHU06.png" alt="image-20251028171851486" style="zoom:50%;" />

**3.3、工程代码：**

> `float temperature, humidity`不能直接定义成`float *temperature, *humidity`：<span style="color:red">只是声明了指针，但没有分配内存</span>
>
> 可替换方案：1、`void gxht30_read_data(float *temperature, *humidity)`；2、`float temperature, humidity`；

```C
#include <reg52.h>
#include <stdio.h>
sbit sda = P0 ^ 1;
sbit scl = P0 ^ 2;
#define GXHT3L_ADDR_WRITE ((0x44 << 1) + 0)    
#define GXHT3L_ADDR_READ  ((0x44 << 1) + 1)
// ================= 延时函数 =================
void delay_ms(unsigned int xms) {
    unsigned int i, j;
    for (i = xms; i > 0; i--) {
        for (j = 124; j > 0; j--) {}
    }
}
// ================= I2C基本时序 =================
void i2c_start();
void i2c_stop();
void i2c_write_byte(unsigned char wdata);
unsigned char i2c_read_byte();
void i2c_ack();
void i2c_nack();
unsigned char i2c_wait_ack();
// ================= GXHT3L 周期转换测量 =================
// --- Step 1: 设置转换模式 ---
void gxht30_init() {
    i2c_start();
    i2c_write_byte(GXHT3L_ADDR_WRITE);
    i2c_wait_ack();
    i2c_write_byte(0x21);
    i2c_wait_ack();
    i2c_write_byte(0x30);
    i2c_wait_ack();
    i2c_stop();
}
// --- Step 2: 周期测量模式读取数据命令 ---
void gxht30_set_read_mode() {
    i2c_start();
    i2c_write_byte(GXHT3L_ADDR_WRITE);
    i2c_wait_ack();
    i2c_write_byte(0xE0);
    i2c_wait_ack();
    i2c_write_byte(0x00);
    i2c_wait_ack();
    i2c_stop();
}
// --- Step 2: 读取数据并转换 ---
void gxht30_read_data() {
    unsigned short tem, hum;
    int index = 0;
    float temperature, humidity;
    unsigned char buffer[6];
    i2c_start();
    i2c_write_byte(GXHT3L_ADDR_READ);
    i2c_wait_ack();
    for (index = 0; index < 6; index++) {
        buffer[index] = i2c_read_byte();
        if (index == 5)
            i2c_nack();
        else
            i2c_ack();
    }
    i2c_stop();
    //合并两个8bit的数据为一个16bit的数据
    tem = (buffer[0] << 8) | buffer[1];
    hum = (buffer[3] << 8) | buffer[4];
    //进行温湿度转换
    temperature = (175.0 * (float) tem / 65535.0 - 45.0);
    humidity = (100.0 * (float) hum / 65535.0);
    printf("temperature=%f humidity=%f\n", temperature, humidity);
}
// ================= UART + printf重写 =================
void uart_init(void) {
    PCON &= 0x7F;
    SCON = 0x50;
    TMOD &= 0x0F;
    TMOD |= 0x20;
    TL1 = 0xFD;
    TH1 = 0xFD;
    TR1 = 1;
}
char putchar(char dat) {
    SBUF = dat;
    while (!TI);
    TI = 0;
    return dat;
}
// ================= main函数 =================
void main() {
    uart_init();
    gxht30_init();
    while (1) {
        delay_ms(1000);
        gxht30_set_read_mode();
        gxht30_read_data();

    }
}
```

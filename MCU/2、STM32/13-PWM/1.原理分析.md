## 1、<span style="color:brown">PWM分析：</span>

**1.1、概述：**

**PWM（Pulse-Width Modulation，脉冲宽度调制）**，本质上是一种**时间域的数字调制技术**。

一种通过**调整脉冲信号**的<span style="color:red">高电平持续时间（Ton）和低电平持续时间（Toff）的比例</span>来**控制电路输出**的技术。

**1.2、频率与占空比：**

<u>数学逻辑含义</u>：

| 频率（`f`） / 周期（`T`） | `f = 1 / T` | `T  = Ton + Toff` |
| :-----------------------: | :---------: | :---------------: |

<img src="https://raw.githubusercontent.com/root-bine/image/main/Typora-image/PWM01.png" alt="image-20251012124949747" style="zoom:50%;" />

| 占空比（`Duty Cycle`，`D`） | `D = Ton / T` | 通常用百分比表示（`0% ~ 100%`） |
| :-------------------------: | :-----------: | :-----------------------------: |

<img src="https://raw.githubusercontent.com/root-bine/image/main/Typora-image/PWM02.png" alt="image-20251012125126878" style="zoom:50%;" />

<u>物理逻辑含义</u>：

在**物理实际电路**中，等式`Duty = Ton / T`含义为：<span style="color:red">**有效电平**</span>占**周期**的比例。



## 2、<span style="color:brown">PWM 取模问题：</span>

**2.1、代码分析：**

> `%` 不是<span style="color:red">纯逻辑判断</span>，而是<u>**一次操作**：<span style="color:red">除法 + 余数 + 写入</span></u>。

```c
int count = 0;  // 全局
Function: 		// 1 ms触发
	count++;
	方式1: count %= 100;
	方式2: if(count >= pwm_period) {
		   		count = 0;
		   }
```

`count = 0 ~ 100`，即：PWM周期 = `100 ms`，得出频率为`10 Hz`。

<span style="color:red">LED亮度**动态变化**</span>情境：

- 在电机操控中，使用两种方式均可；
- <u>*LED不能采用**方式2***</u>；

**2.2、分析整理：**

|         项目         | 电机 PWM          | LED PWM                             |
| :------------------: | ----------------- | ----------------------------------- |
|       典型频率       | `50 Hz`～`500 Hz` | `1 kHz`～`10 kHz`                   |
|       响应速度       | 慢（ms 级）       | 快（µs 级）                         |
|       输出要求       | 平均能量稳定      | 周期时间稳定                        |
| **`Duty`抖动**敏感性 | 低                | <span style="color:red">高</span>   |
|  **周期抖动**敏感性  | 低                | <span style="color:red">极高</span> |
|    是否能用 `%=`     | ✅ 可以            | ❌ 不建议                            |



## 3、<span style="color:brown">通用定时器：</span>

**3.1、Timer与PWM：**

`STM32`内置**多个IO**输出**PWM通道**，其中：

- 高级定时器：TIM1、TIM8；
- 通用定时器：TIM2、TIM3、TIM4、TIM5

都**有独立的通道**可以<span style="color:red">用来作为PWM输出模式</span>，**对应通道根据芯片手册的GPIO复用**。

**3.2、TIM3 Mode and Configuration：**

<img src="https://raw.githubusercontent.com/root-bine/image/main/Typora-image/STM32_PWM_01.png" alt="image-20251202153212859" style="zoom:50%;" />

对于`Timer`的**Channel模式**，说明如下：

<u>`input capture direct mode` (输入捕获模式)</u>：

- 输入捕获模式对**输入的信号的上升沿，下降沿、双边沿**进行**捕获**；
- 常用来测量<u>输入信号的脉宽、频率和占空比</u>；

✔️<u>`Output Compare XX` (输出比较模式)</u>：

- <u>可以<span style="color:green">输出四路频率不同，占空比不同的PWM</span></u> (都**完全独立**)；

✔️<u>`PWM Generation XX` (PWM模式)</u>：

- <span style="color:purple">可输出的四路PWM</span>，但四路通道的<span style="color:purple">频率是一致的</span>，只有**占空比是独立的**；

<u>`Forced output` (强制输出模式)</u>：

- **直接由软件强置为有效或无效状态**，而不依赖于<u>输出比较寄存器和计数器间的比较结果</u>；



## 4、<span style="color:brown">PWM配置：</span>

**4.1、Counter Settings：**

设定**Timer的溢出时间**，即**PWM周期**为`2 kHZ (500 us触发一次溢出)`：

已知定时器时钟频率为`72 MHZ`，对其预分频：

- `Prescaler (PSC-16 bits value) = 72 - 1`(`72 MHZ / 1MHz`)；
- 定时器时钟频率重新分频为`1 MHZ (1 us计数一次)`；

因此，`Counter Period = 500`，同时`Counter Mode = UP`、`auto-reload preload = Enable`。

<u>`Internal Clock Division` (`CKD`，时钟分频因子)</u>设置为不分频，即`No Division`。

**4.2、Mode与CH Polarity：**

<img src="https://raw.githubusercontent.com/root-bine/image/main/Typora-image/STM32_PWM_02.png" alt="image-20251202162842473" style="zoom:50%;" />

可以<u>通过`CH Polarity`设置有效电平为`HIGH_LEVEL / LOW_LEVEL`</u>，然后<span style="color:red">根据`Mode`的类型进行确定`Duty`比例</span>：

|    `Mode`    | `CNT < CCRx` | `CNT ≥ CCRx` |
| :----------: | :----------: | :----------: |
| `PWM Mode 1` |   有效电平   |   无效电平   |
| `PWM Mode 2` |   无效电平   |   有效电平   |

**4.3、Pulse：**

该参数表示占空比，可以**在STM32CubeMX进行设置**，也可以**交由软件代码进行设置**。

- 由于设定的`Counter Period = 500`，则`duty = pulse / 500 (pulse = 0 ~ 500)`。

**4.4、Output compare preload：**

**输出比较预装载**允许**在当前PWM周期结束之前**，<span style="color:red">设置新的`duty / compare value`，新的值会在**下一个周期开始时**才生效</span>。

这样可以避免在**调整PWM信号参数时产生的突变或毛刺**，使得<u>`PWM`输出的变化更为平滑连续</u>。



## 5、<span style="color:brown">PWM函数：</span>

> 关于中断、DMA函数，参考HAL库手册

**5.1、修改Duty：**

````c
"stm32_hal_legacy.h":
// 修改分频系数, 修改Duty
#define __HAL_TIM_PRESCALER             __HAL_TIM_SET_PRESCALER
// 修改自动重装载值, 修改Duty
#define __HAL_TIM_SetAutoreload         __HAL_TIM_SET_AUTORELOAD
// 获取自动重装载值
#define __HAL_TIM_GetAutoreload         __HAL_TIM_GET_AUTORELOAD
// 修改比较值, 修改Duty
#define __HAL_TIM_SetCompare            __HAL_TIM_SET_COMPARE
// 获取比较值
#define __HAL_TIM_GetCompare            __HAL_TIM_GET_COMPARE
````

**5.2、PWM使能：**

````c
// 开启或关闭PWM
HAL_StatusTypeDef HAL_TIM_PWM_Start(TIM_HandleTypeDef * htim, uint32_t Channel) 
HAL_StatusTypeDef HAL_TIM_PWM_Stop( TIM_HandleTypeDef * htim, uint32_t Channel) 
````

⭐上述函数查看源码，<span style="color:red">内部已调用Timer使能函数</span>，因此**在开启PWM时**，<span style="color:red">无需重复开启Timer</span>。

## 1、<span style="color:brown">发送流程：</span>

以**模式1**为例，**发送**流程结构图：

<img src="https://raw.githubusercontent.com/root-bine/image/main/Typora-image/UART17.png" alt="image-20251007164101478" style="zoom: 67%;" />



## 2、<span style="color:brown">模式选择：</span>

**2.1、模式分类：**

|    编号    | 名称 / 类型    | 数据位数                       | 波特率                                   |
| :--------: | :------------- | ------------------------------ | ---------------------------------------- |
| **模式 0** | 同步移位寄存器 | 8 位                           | **固定波特率**：`fosc/12`                |
| **模式 1** | 异步 UART      | 10 位（1起始 + 8数据 + 1停止） | **可变波特率**（由`Timer1`产生）         |
| **模式 2** | 异步 UART      | 11 位（1起始 + 9数据 + 1停止） | **固定波特率**（`fosc/64` 或 `fosc/32`） |
| **模式 3** | 异步 UART      | 11 位（1起始 + 9数据 + 1停止） | **可变波特率**（由`Timer1`产生）         |

模式0主要用于<span style="color:green">并行口扩展</span>。

<span style="color:red">模式1是最常用的工作模式</span>。

模式2的数据段，**多出的第9位**可作**校验位**或**地址识别位**。

**2.2、配置模式1：**

<img src="https://raw.githubusercontent.com/root-bine/image/main/Typora-image/UART18.png" alt="image-20251007163302012" style="zoom:80%;" />

```c
SM0 = 0;
SM1 = 1;
或
SCON = 0x40;                // 0100 0000 串口工作模式1
```



## 3、<span style="color:brown">波特率配置：</span>

**3.1、参数配置：**

根据**常用波特率与定时器/计数器1各参数关系**，设置波特率为`9600`：

| PCON.7 / SMOD = 0 | TMOD.6 / C/T = 0 | Mode2：8 bit auto load | 预装载值 = 0xFD |
| ----------------- | ---------------- | ---------------------- | --------------- |

**3.2、Timer1配置：**

```c
TMOD &= 0x0F;  //清空TMOD中定时器1相关
TMOD |= 0X20;  //设置定时器1工作模式2 8位自动重载，这里为什么使用|=而不使用=呢，为了避免清除定时器0配置
TH1 = 0xFD;    //设定初值
TL1 = 0XFD;    //设定装载值 
TR1 = 1;       //打开计数器
```

多定时器情况下， `TCOM = 0x20`会导致`Timer0`设置被修改，因此做如下修改：

- `TMOD &= 0x0F`：清理`Timer1`中可能残留的数据，并保留`Timer0`的配置；
- `TMOD |= 0X20`：设置`Timer1`新数值时，确保`Timer0`数值保留；

**3.3、PCON配置：**

```c
PCON |= 0X00;  //设置B7为0
```



## 4、<span style="color:brown">校验位：</span>

<img src="https://raw.githubusercontent.com/root-bine/image/main/Typora-image/UART19.png" alt="image-20251007165205262" style="zoom:67%;" />

在**模式2、模式3**作为**校验位**。**模式1**是`8 bit`的，<span style="color:red">**无需校验位**</span>。



## 5、<span style="color:brown">UART发送数据：</span>

> 烧录代码后，点按芯片复位键，即可在串口工具接收到数据

**5.1、发送0x30：**

```c
#include <reg52.h>
void UartInit() {           //9600bps、11.0592MHz
        SCON = 0x40;        //0100 0000 串口工作模式1
        TMOD &= 0x0F;       //清空TMOD中定时器1相关
        TMOD |= 0X20;       //工作模式2: 8位自动重载
        TH1 = 0xFD;         //设定定时初值
        TL1 = 0XFD;
        TR1 = 1;            //启动定时器1
        PCON |= 0X00;
}
void main() {
        UartInit(); //调用串口初始化函数
        SBUF = 0x30;
        while(1) {}        
}
```

**5.2、发送字符串：**

```c
#include <reg52.h>
void UartInit() {
        SCON = 0x40;
        TMOD &= 0x0F;
        TMOD |= 0X20; 
        TH1 = 0xFD;
        TL1 = 0XFD;
        TR1 = 1;
    	PCON |= 0X00;
}
void send_string(unsigned char str[]) {
                unsigned char i=0;
                while(str[i]!='\0') { //判断是否到字符串尾
                        SBUF = str[i];
                        while(TI==0);    //等待发送完成, 发送完成硬件会置1
                        TI=0;            //下次发送前, 软件置0
                        i++;             //下次发送
                }        
}
void main() {
        UartInit();//调用串口初始化函数
        send_string("hello world!!");
        while(1) {}        
}
```

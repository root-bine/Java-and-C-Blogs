## 1、<span style="color:brown">DMA介绍：</span>

**1.1、DMA概述：**

`DMA`，全称`Direct Memory Access`，即**直接存储器访问**。

**DMA传输**将数据从<span style="color:red">一个地址空间复制到另一个地址空间</span>，提供在**高速数据传输**：

- `Peripheral <------> Memory`；
- `Memory <------> Memory`；

**1.2、DMA与外设：**

<img src="https://raw.githubusercontent.com/root-bine/image/main/Typora-image/STM32_UART07.png" alt="image-20251127161056682" style="zoom:40%;" />

`STM32F103RC`有<span style="color:red">12个独立的可配置的通道(请求)</span>：`DMA1`有`7`个通道，`DMA2`有`5`个通道。



## 2、<span style="color:brown">DMA Setting设置：</span>

**2.1、Mode：**

|                            Normal                            |                       Circular                        |
| :----------------------------------------------------------: | :---------------------------------------------------: |
| 当一次`DMA`传输完后，停止`DMA`传送 ，下次传输则需要**重新开启DMA传输** | <u>传输完成后又重新开始继续传输</u>，不断循环永不停止 |

**2.2、Increment Address：**

`Peripheral`表示外设地址寄存器，`Memory`表示内存地址寄存器，均为：设置**传输数据的时候**，<span style="color:red">地址是不变 / 递增</span>。

- 如果**设置为递增**，则下一次传输的时候，地址加**Data Width个字节** 。

**2.3、Data Width：**

 一般的`UART / USART`都是`8 bit`，因此**使用默认的DMA配置即可，也就是指针自增为Byte**。

**2.4、DMA函数优先级：**

`MX_DMA_Init()`函数需要在**其他初始化前调用**，否则DMA收发数据会出现异常。

在`STM32CubeMX`项目，选择`Project Manager -> Advanced Settings`，手动调节函数排序。



## 3、<span style="color:brown">功能实现：</span>

**3.1、DMA收发：**

````c
"main.c -> 全局变量":
uint8_t rxbuf[10];
uint8_t sxbuf[] = "hello world";
"main.c -> while(1)":
if(HAL_UART_Receive_DMA(&huart1, rxbuf, sizeof(rxbuf)) == HAL_OK) {
	HAL_UART_Transmit_DMA(&huart1,sxbuf,sizeof(sxbuf));
}
HAL_Delay(500);
````

当**MCU**每接收`uint8_t rxbuf[10]`的数据，就会向**上位机**发送一次`hello world`。

**3.2、串口中断 + DMA：**

> 需要打开USART的中断使能

````c
"main.c -> 全局变量":
uint8_t rxbuf[10];
uint8_t ackbuf[] = "ack pack";
"main.c -> main()":
HAL_UART_Receive_IT(&huart1, rxbuf, sizeof(rxbuf)); // 初始化串口
"main.c -> main() After":
void HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart){        
      if(huart == &huart1) {  //判断中断是否来自于串口1
          HAL_UART_Transmit_DMA(&huart1,sxbuf,sizeof(sxbuf));  //通过中断的方式发送应答数据出去
          HAL_UART_Receive_DMA(&huart1, rxbuf, sizeof(rxbuf));   //开始接收下一轮数据
      }
}
````


## 1、<span style="color:brown">PWM控制呼吸灯：</span>软件空转延时

```c
#include <reg52.h>
sbit led = P2^7;
int time = 0;
void Delay10usofTime(unsigned int time) {	// 根据time决定执行多少次10us延时
	while(time--) {
		unsigned char data i;
		i = 2;
		while (--i);
	}
}
void main() {
	while(1) {
		for(time = 0; time < 300; time ++){ //从暗逐渐变亮的过程
			led = 0;
      		Delay10usofTime(time);
      		led = 1;
      		Delay10usofTime(300 - time);
    	}
    	for(time = 0; time < 300; time ++){ //从亮逐渐变暗的过程
      		led = 1;
      		Delay10usofTime(time);
      		led = 0;
      		Delay10usofTime(300 - time);
    	}
  	}
}
```

`Delay10usofTime(time) + Delay10usofTime(300 - time)`组成一个完整的**PWM周期**。

而`for(time = 0; time < 300; time ++)`是**动态调整Duty的占比**。



## 2、<span style="color:brown">PWM控制呼吸灯：</span>定时器中断

**2.1、配置必要参数：**

```c
#include <reg52.h>
#define TIME_OUT (65536 - 9)
sbit led = P2^7;
int time = 0;
bit dir = 1;                    // 占空比变化方向：1=递增（渐亮），0=递减（渐暗）
unsigned int pwm_period = 300;  // PWM周期
unsigned int count = 0, duty = 0;
```

**2.2、Timer配置与延时：**

```c
void Timer0Init() {
    TMOD &= 0xF0;
    TMOD |= 0x01;
    TL0 = TIME_OUT;
    TH0 = TIME_OUT >> 8;
    ET0 = 1;
    EA = 1;
    TR0 = 1;
}
void Delay10usofTime(unsigned int time) {	// 根据time决定执行多少次10us延时
	while(time--) {
		unsigned char data i;
		i = 2;
		while (--i);
	}
}
```

**2.3、中断服务函数：**

```c
void Timer0_ISR() interrupt 1 {
    TL0 = TIME_OUT;
    TH0 = TIME_OUT >> 8;
    count++;
    if(count >= pwm_period) {
		count = 0;
	}
    if (count < duty) {
        led = 0;  // 对应原代码的LED点亮状态
    } else {
        led = 1;  // 对应原代码的LED熄灭状态
    }
}
```

通过`count`限定一个完整的**PWM周期**，并与`duty`进行比较，设定**<span style="color:red">有效电平</span>占比**。

**2.4、main函数：**

```c
void main() {
    Timer0Init();  // 初始化定时器
    while(1) {
        if (dir == 1) { // 渐亮过程：占空比从0增加到pwm_period-1
            duty++;
            if (duty >= pwm_period) {
                dir = 0;  // 达到最亮，切换为渐暗
            }
        } else { // 渐暗过程：占空比从pwm_period-1减少到0
            duty--;
            if (duty == 0) {
                dir = 1;  // 达到最暗，切换为渐亮
            }
        }
		// 控制 渐亮过程&渐暗过程 的交替速度
        Delay10usofTime(10);
    }
}
```


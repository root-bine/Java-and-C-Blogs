## 1、<span style="color:brown">模式梳理：</span>

**1.1、 Mode1结构图：**

<img src="https://raw.githubusercontent.com/root-bine/image/main/Typora-image/Timer07.png" alt="image-20250915161019337" style="zoom:67%;" />

此模式下，`Timer0`配置为**16位定时器/计数器**，由`8 bit_TL0`和`8 bit_TH0`构成。

**1.2、其余模式：**

`Mode_0`属于**`89C51`早期设计遗留**，<span style="color:red">因为范围太小，已经被`Mode_1`替代</span>。

`Mode_1、Mode_2`工作模式，**配置思路相同**，区别在于**预装载值的配置方式**。

`Mode_3`是将`Timer0` 拆分成<u>**两个`8 bit_Timer`**（`TL0`、`TH0`）</u>，其缺点：

1. `Timer1`功能受限：`TH0`会借用`Timer1`的控制位（`TR1、TF1`）；
2. `CPU`负担大：`8 bit_Timer`溢出频率太高，需要**不断`Reload / Interrupt`**；



## 2、<span style="color:brown">模式选择：</span>

对照`datasheet`，根据`TMOD`寄存器结构：

<img src="https://raw.githubusercontent.com/root-bine/image/main/Typora-image/Timer05.png" alt="image-20250915153320746" style="zoom:67%;" />

选择**定时器`Timer0`**，设置工作模式为**模式1**。



## 3、<span style="color:brown">时钟源：</span>

**3.1、结构图与配置：**

<img src="https://raw.githubusercontent.com/root-bine/image/main/Typora-image/Timer08.png" alt="image-20250915163110335" style="zoom:50%;" />

<img src="https://raw.githubusercontent.com/root-bine/image/main/Typora-image/Timer14.png" alt="image-20250916121354178" style="zoom: 67%;" />

| 模式         | C/T=0 (定时器)                                               | C/T=1 (计数器)                                               |
| ------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **计数来源** | 内部时钟                                                     | 外部引脚脉冲（`T0/T1`）                                      |
| **用途**     | <span style="color:red">计时、延时、周期任务</span>          | <span style="color:green">事件计数（转速、次数、外部信号）</span> |
| **应用场景** | <span style="color:red">1ms 定时中断、LED 闪烁、采样定时</span> | <span style="color:green">电机转速检测、红外计数、测速仪</span> |

**3.2、分频模式：**

<img src="https://raw.githubusercontent.com/root-bine/image/main/Typora-image/Timer09.png" alt="image-20250915165414427" style="zoom: 67%;" />

**主时钟频率是`12 MHz`**进行**12分频**就是`1 MHz`（<span style="color:red">`1 MHz = 1000 kHz, 1 kHz = 1000 Hz`，`1 s`计数`100`万次</span>），<u>每隔<span style="color:red">**1 us**</span>记**1次数**</u>。

`Timer0`的速率，可以在`STC-ISP`设置：

<img src="https://raw.githubusercontent.com/root-bine/image/main/Typora-image/Timer10.png" alt="image-20250915165115906" style="zoom: 67%;" />



## 4、<span style="color:brown">开关控制：</span>

<img src="https://raw.githubusercontent.com/root-bine/image/main/Typora-image/Timer11.png" alt="image-20250915171154208" style="zoom:50%;" />

`GATE、INT0、TR0`一起作为**定时器开关的控制寄存器**：

<img src="https://raw.githubusercontent.com/root-bine/image/main/Typora-image/Timer13.png" alt="image-20250916121656488" style="zoom:80%;" />

| <span style="color:red">GATE</span> | INT0 | <span style="color:red">TR0</span> | 定时器状态 |
| ----------------------------------- | ---- | ---------------------------------- | ---------- |
| 0                                   | /    | 1                                  | 使能       |
| /                                   | 1    | 1                                  | 使能       |



## 5、<span style="color:brown">预装载值：</span>

**5.1、时基单元：**

> 该图片为13 bit Timer

<img src="https://raw.githubusercontent.com/root-bine/image/main/Typora-image/Timer12.png" alt="image-20250915171720205" style="zoom: 67%;" />

计数器里有**两个时基单元**：**TL0（低5位）**和 **TH0（高8位）**总共**13位**，所以叫**13位定时/计数器**。

`TL0`的**5位溢出**会向**`TH0`进位**，<u>`TH0`计数溢出</u>就**置位TCON中**，即：<span style="color:blue">溢出标志位`TF0`</span>。

**5.2、数值计算：**

假如**16位定时/计数器**，因此<u>最多可以计数 **`2^16`次**</u>，即：**定时器增加到`65536`时，会触发中断溢出**。

**`STC89C52RC/RD+`单片机时钟频率**是`11.0592 MHz`时，在**12T模式**：

- 定时器频率：`11.0592 MHz /12 = 0.9216 MHz`；
- `1 s`计数**`921600`次**：`10 ms`计数`9216`次；



## 6、<span style="color:brown">定时器应用：</span>

**6.1、LED间隔1s闪烁：**

```c
#include <reg52.h>
#define TIME_OUT (65536 - 9216) // 设置溢出时间10ms
int count = 0;
sbit LED2 = P2 ^ 6;
void time0() interrupt 1{ /*中断函数*/
    count++;
	if(count >= 100) { // 间隔1s闪烁
		LED2 = ~LED2; 
        count = 0;
	}
	TL0 = TIME_OUT;
	TH0 = TIME_OUT >> 8;
}
void main() {
	TMOD = 0x01;
	TL0 = TIME_OUT; 
	TH0 = TIME_OUT >> 8;
	TR0  = 1;
	ET0 = 1;
	EA  = 1;
	while(1){}
}
```

**6.2、KEY控制LED：**

> 软件空转延时消抖，参照《Button -> 机械按键》

**<u>Timer消抖原理</u>**：

1. 判断按键**是否按下**；
2. 若**检测到`Key_Drop`**，则**开启`Timer`**：
   - 定时时间为`10 ms`左右；
   - 使得按键按下`10ms`后进入定时中断（进入中断时，按键抖动时间已过）；
3. 在定时器中断中，**再次判断按键是否按下**；
4. 关闭定时器，等待按键松开；

```c
#include <reg52.h>
#define TIME_OUT (65536 - 9216)
sbit LED2 = P2 ^ 6;
sbit KEY2 = P3 ^ 6;
void time0() interrupt 1{
	TL0 = TIME_OUT;
	TH0 = TIME_OUT >> 8;
	TR0  = 0;
	if(KEY2 == 0) {
		LED2 = ~LED2; 
    	while(KEY2 == 0); // 检测KEY2电平变化, 返回main函数
	}
}
void main() {
	TMOD = 0x01;
	TL0 = TIME_OUT;
	TH0 = TIME_OUT >> 8;
    TR0  = 0;
	ET0 = 1;
	EA  = 1;
	while(1){
		if(KEY2 == 0) {
			TR0  = 1;
		}
        // 其它主循环任务可以放这里
	} 
}
```

## 1、<span style="color:brown">定时器介绍：</span>

**1.1、Timer分类：**

|   基本定时器   |         TIM6、TIM7         |
| :------------: | :------------------------: |
| **通用定时器** | **TIM2、TIM3、TIM4、TIM5** |
| **高级定时器** |       **TIM1、TIM8**       |

**1.2、功能对比：**

<img src="https://raw.githubusercontent.com/root-bine/image/main/Typora-image/STM32_Timer02.png" alt="image-20251119173829649" style="zoom:67%;" />

✅仅作为**定时器计数**功能，三类`Timer`的<u>配置与使用</u>是一致的。

**1.3、计数模式：**

<img src="https://raw.githubusercontent.com/root-bine/image/main/Typora-image/STM32_Timer03.png" alt="image-20251119180048121" style="zoom:60%;" />

|   Mode   |                           Explain                            |
| :------: | :----------------------------------------------------------: |
| 向上计数 | `Counter` 从<span style="color:red">**0**</span>增加到**自动加载值**(`TIMx_ARR`)，<u>再从 <span style="color:red">**0**</span>开始计数</u>， 产生一个**计数器溢出事件** |
| 向下计数 | `Counter`从`TIMx_ARR`减少到<span style="color:red">**0**</span>，<u>再从`TIMx_ARR`开始计数</u>，产生一个**计数器溢出事件 ** |
| 中央对齐 | 1. `Counter` 从<span style="color:red">**0**</span>增加到<span style="color:blue">`TIMx_ARR - 1`</span>，产生一个**计数器溢出事件** <br>2. 从<span style="color:blue">`TIMx_ARR - 1`</span>减少到<span style="color:green">**1**</span>，产生一个**计数器溢出事件**，<u>再从 <span style="color:red">**0**</span>开始计数</u> |



## 2、<span style="color:brown">工作原理：</span>

**2.1、定时器框图：**

<img src="https://raw.githubusercontent.com/root-bine/image/main/Typora-image/STM32_Timer01.png" alt="image-20251119173829649" style="zoom:50%;" />

**2.2、时钟产生器：**

> 根据**STM32技术参考手册**：6.2 时钟 -> 图8 时钟树

`STM32`定时器有**4种时钟源选择**：

|  时钟源   |                           Explain                            |
| :-------: | :----------------------------------------------------------: |
| ①内部时钟 | `STM32F103`定时器的**时钟源**：<br>`TIM1`、`TIM8`：来自**APB2总线**上的`TIMxCLK`<br>`TIM2 ~ TIM7`：来自**APB1总线**上的`TIMxCLK` |
| ②外部时钟 |             通过`TIMx_ETR`，接收**外部引脚输入**             |
| ③内部触发 | 1. 通过`ITRx (x = 0, 1, 2, 3)`设置<br>2. 将任意`Timer`设置为预分频器 |
| ④外部时钟 |            通过`TI1FP1 / TI1F_ED`与`TI2F_ED`设置             |

**2.3、时基单元：**

计数器寄存器（`TIMx_CNT`)：设置**计数模式**；

预分频器寄存器（`TIMx_PSC`)：将**时钟频率**按<u>`0`到`65535`之间的任意值</u>进行**分频**；

自动装载寄存器（`TIMx_ARR`)：设置**计数器的最大计数值**，决定**定时器的周期**；



## 3、<span style="color:brown">定时器参数：</span>

**3.1、Counter设置：**

> `TIMx_ARR`，自动重装载寄存器

|       name       |      Explain      |                Value                 |
| :--------------: | :---------------: | :----------------------------------: |
| `Prescaler(PSC)` | `Timer`预分频设置 | 范围： `0~65535`，数值 = `value - 1` |
|  `Counter Mode`  | `Timer`的计数方式 |         向上、向下、中央对齐         |
| `Counter Period` |    `Timer`周期    | 范围： `0~65535`，数值 = `value - 1` |

|         name          | Explain  |                            Value                             |
| :-------------------: | :------: | :----------------------------------------------------------: |
| `Auto-reload preload` | 自动重载 | `Disable`：`TIMx_ARR`写入**新值**后，计数器<span style="color:red">立即产生**计数溢出**</span>，然后开始新的计数周期 |
|                       |          | `Enable`：`TIMx_ARR`写入**新值**后，计数器<span style="color:green">完成**当前旧的计数**</span>后，再开始新的计数周期 |

**3.2、Trigger Output Parameters (触发输出参数)：**

|     TRGO选项      |                        机制                        |          触发时机          | 常见用途                    |
| :---------------: | :------------------------------------------------: | :------------------------: | --------------------------- |
| `Reset (UG bit)`  |    <span style="color:red">手动产生触发</span>     |         写`UG`位时         | 软件触发`DAC/ADC`☑️          |
| `Enable (CNT_EN)` |                 定时器启动触发一次                 |   `TIMx_CR1.CEN`置`1`时    | 同步多个模块起始时间        |
|  `Update Event`   | <span style="color:red">`Timer`周期触发溢出</span> | `CNT → ARR` 发生更新事件时 | DAC / DMA / ADC 的周期触发✅ |

**3.3、Master/Slave Mode (MSM bit, 主从模式) ：**

|          Mode           |     Explain     |
| :---------------------: | :-------------: |
| `External Clock Mode 1` | 外部触发模式`1` |
|    `Reset Mode IRC`     |    重置模式     |
|      `Gated Mode`       |    门控模式     |
|     `Trigger Mode`      |    触发模式     |

**1.4、其他参数：**

> `InternalCLock Division(CKD)`，与**输入捕获**相关
>
> `Repetition Counter`，属于<u>**高级控制寄存器**专用寄存器位</u> 

|             name              |          Explain          |                            Value                             |
| :---------------------------: | :-----------------------: | :----------------------------------------------------------: |
| `InternalCLock Division(CKD)` |     内部时钟分频因子      | 设置`Timer`**时钟频率**与**数字滤波器采样频率**之间的<u>分频比例</u> |
|     `Repetition Counter`      | 重复计数器(`RCR -8 bits`) |                     控制输出`PWM`的个数                      |

## 1、<span style="color:brown">中断概述：</span>

**1.1、EXTI介绍：**

**外部中断**（`EXtern Interrupt`），简称：`EXTI`，用于<span style="color:red">监测<u>指定`GPIO`的电平信号</u></span>：

- 当指定的`GPIO`**产生电平变化**，`EXTI`立即向`NVIC`**发出中断申请**；
- `NVIC`裁决后即可**中断`CPU`主程序**，使<u>`CPU`执行`EXTI`对应的中断处理函数</u>；

**嵌套向量中断控制器**（`Nested Vectored Interrupt Controller`）简称：`NVIC`，用于<span style="color:red"><u>管理所有中断的优先级、嵌套、中断屏蔽、分发和响应</u></span>。

**1.2、触发方式：**

````ABAP
External Interrupt Mode with Rising edge trigger detection         上升沿 触发外部中断
External Interrupt Mode with Falling edge trigger detection        下降沿 触发外部中断 
External Interrupt Mode with Rising/Falling edge trigger detection 上升沿/下降沿 触发外部中断 
````

````apl
External Event Mode with Rising edge trigger detection             上升沿 触发外部事件 
External Event Mode with Falling edge trigger detection            下降沿 触发外部事件 
External Event Mode with Rising/Falling edge trigger detection     上升沿/下降沿 触发外部事件
````

**1.3、系统时基计时:**

````c
__weak uint32_t HAL_GetTick(void) {
  return uwTick;
}
````

☑️从<u>**程序开始运行**（`HAL_Init()`初始化`SysTick`后）</u>就开始计数，并且<u>以`1 ms`自增一次</u>，直到**MCU复位 / 断电**。

`__weak`表明函数为<span style="color:green">**弱函数**</span>，**可重定义**：

| 1、重定义函数，在编译时会跳转到该函数 | 2、不重定义，则跳转至默认函数位置 |
| ------------------------------------- | --------------------------------- |



## 2、<span style="color:brown">结构流程：</span>

**2.1、EXTI线路映射：**

`EXTI`支持配置**20个中断和事件屏蔽位**：

<img src="https://raw.githubusercontent.com/root-bine/image/main/Typora-image/STM32_EXTI_01.png" alt="image-20251117170241683" style="zoom: 50%;" />

✅在`STM32CubeMX`配置时，每一条`EXTI`<span style="color:red">有且只能配置一个`GPIO`引脚</span>。

**2.2、EXTI框图：**

<img src="https://raw.githubusercontent.com/root-bine/image/main/Typora-image/STM32_EXTI_02.png" alt="image-20251117163959190" style="zoom:50%;" />

`AFIO`主要用于<span style="color:red">复用功能引脚重映射</span>，<span style="color:red">中断引脚选择</span>。

`GPIO`引脚**电平变化**，通过**AFIO引脚**选择通向**EXTI边沿检测**：1、中断触发；2、事件触发。



## 3、<span style="color:brown">中断优先级：</span>

**3.1、体系概览：**

✅<span style="color:red">最高优先级为`0`</span> ，若`Preempt Priority` == `Sub Priority`，则按照**中断向量表顺序**进行执行。

`STM32`的**中断优先级**由 <u>`NVIC`（`Nested Vectored Interrupt Controller`）统一管理</u>，优先级分两类：

|                  Types                  |                       Rules                       |
| :-------------------------------------: | :-----------------------------------------------: |
|    `Preempt Priority`（抢占优先级）     | ✅抢占优先级**低**的`ISR`不能打断**高优先级**`ISR` |
| `Sub Priority`（子优先级 / 响应优先级） |           ☑️决定同抢占级别中断的执行顺序           |

**3.2、优先级分组：**

````c
"stm32f1xx_hal_cortex.c"
void HAL_NVIC_SetPriorityGrouping(uint32_t PriorityGroup) {
  /* Check the parameters */
  assert_param(IS_NVIC_PRIORITY_GROUP(PriorityGroup));
  /* Set the PRIGROUP[10:8] bits according to the PriorityGroup parameter value */
  NVIC_SetPriorityGrouping(PriorityGroup);
}
````

`uint32_t PriorityGroup`含义如下（以`Cortex-M3 / M4`为例，`4 bit`优先级）：

|     Priority Group     |    抢占优先级 bit     |    响应优先级 bit     |
| :--------------------: | :-------------------: | :-------------------: |
| `NVIC_PRIORITYGROUP_0` |   `0` , `value = 0`   | `4`, `value = [0,15]` |
| `NVIC_PRIORITYGROUP_1` | `1`, `value = [0,1]`  | `3`, `value = [0,7]`  |
| `NVIC_PRIORITYGROUP_2` | `2`, `value = [0,3]`  | `2`, `value = [0,3]`  |
| `NVIC_PRIORITYGROUP_3` | `3`, `value = [0,7]`  | `1`, `value = [0,1]`  |
| `NVIC_PRIORITYGROUP_4` | `4`, `value = [0,15]` |   `0`, `value = 0`    |

**3.3、NVIC流程：**

````c
"gpio.c"
HAL_NVIC_SetPriority(EXTI2_IRQn, 2, 0); // 设置优先级
HAL_NVIC_EnableIRQ(EXTI2_IRQn);         // 中断使能
````

````c
void HAL_NVIC_SetPriority(IRQn_Type IRQn, uint32_t PreemptPriority, uint32_t SubPriority)
    - IRQn: 中断通道
    - PreemptPriority: 抢占优先级
    - SubPriority: 响应优先级
````

⭐一个中断的完整运行优先级由<span style="color:red">抢占优先级 + 响应优先级</span>决定。


## 1、<span style="color:brown">触控按键：</span>

**1.1、原理图：**

<img src="https://raw.githubusercontent.com/root-bine/image/main/Typora-image/Button04.png" alt="image-20250911160224829" style="zoom:50%;" />

`QC`连接芯片的**`P4 IO`端口**，即：`P4.3`。

| IO端口 |                   引脚                    |
| :----: | :---------------------------------------: |
|   P4   | `P4.0, P4.1, P4.2, P4.3`，复位值：`1111B` |

**1.2、PT2041AT6数据手册：**

> `PT2041AT6`，是一种**单通道触摸检测**芯片

在[立创商城](https://www.szlcsc.com/?c=Q2&msclkid=85859f04a7d610fa116ff7c6258add7d&lcsc_vid=ElhZUQVWQQAIUABURANWBgJQFVhcUwEHRlRfX1NQE1kxVlNTQFRZUFxURVVcVzsOAxUeFF5JWAIASQYPGQZABAsLWA%3D%3D)，查找**`PT2041AT6`芯片**的`datasheet`：

<img src="https://raw.githubusercontent.com/root-bine/image/main/Typora-image/Button05.png" alt="image-20250911160627739" style="zoom: 67%;" />



## 2、<span style="color:brown">按键控制：</span>

**2.1、原理解析：**

综合`PT2041AT6`的**原理图**、**数据手册**：

| `TOG`接`GND`，电平为`LOW_LEVEL` | `AHLB`接`3.3 V`，电平为`HIGH_LEVEL` |
| ------------------------------- | ----------------------------------- |

因此，`QC`的**特性**：

- <u>同步模式、CMOS<span style="color:red">低电平有效</span></u>；
- <span style="color:red">默认电平为`HIGH_LEVEL`，按下`Touch Button`，电平变为`LOW_LEVEL`</span>；

**2.2、P4 IO问题解决：**

在`Keil`创建项目时，选择芯片为`AT89C52`，**实验使用`IC`厂商为`STC`**，并非`AT`！因此`#include <reg52.h>`**没有`P4 IO`端口定义**！！

因此，需要结合`datasheet`，手动定义`P4 IO`口：

<img src="https://raw.githubusercontent.com/root-bine/image/main/Typora-image/Button06.png" alt="image-20250911165057947" style="zoom:50%;" />

**2.3、触控按键 + LED亮灭：**

```c
// Function: 按下, LED亮起, 1s后熄灭
// 删除`LED1 = 1;`, 按下KEY, LED常亮, 再按下KEY, LED熄灭
#include <reg52.h>
void delay_ms(unsigned int xms);
sfr  P4   = 0xE8; // Keil选择的是AT89C52, 实验IC为STC, 自定义创建P4 IO
sbit KEY4 = P4 ^ 3;
sbit LED1 = P2 ^ 7;
void main() {
    LED1 = 1;
    if(KEY4 == 0) {
        LED1 = ~LED1;
        delay_ms(1000); // 防止按键被重复触发
    }
}
```

**2.4、触控按键 + 往复流水灯：**

自然情况下，LED从**默认方向**进行流水灯显示。

当按下触控按键，LED流水灯方向改变，松开则恢复默认方向。

```c
#include <reg52.h> 
# define RIGHT	-1
# define LEFT    1
sfr P4 = 0xe8;
sfr XICON = 0xc0;
sbit PX3 = XICON ^ 7;
sbit EX3 = XICON ^ 6;
sbit IE3 = XICON ^ 5;
sbit IT3 = XICON ^ 4;
sbit PX2 = XICON ^ 3;
sbit EX2 = XICON ^ 2;
sbit IE2 = XICON ^ 1;
sbit IT2 = XICON ^ 0;
sbit key1 = P4 ^ 3;
sbit INT2 = P4 ^ 3;
static int led_flag = RIGHT;
static unsigned int led_num = 5;
void delay_ms(unsigned int xms) {
	unsigned int i, j;
  	for(i = xms; i > 0; i--) {
		for(j = 124; j > 0; j--){}
  	}
}
void open_led(unsigned int num) {
    P2 = 0xFF & ~(1 << num);
}
void exit2() interrupt 6 {
  //当按键按下时灯切换
  if(key1 == 0) {
    led_flag = LEFT;
    delay_ms(10);
  }
}
void main() {
  IT2 = 1; //设置中断触发条件为下降沿
  EX2 = 1; //运行中断2经过
  EA = 1; //使能中断
  while(1) {
    open_led(led_num);
    delay_ms(1000);
    // 松开按键时, 重置led_flag
    if(led_flag == LEFT && key1 == 1) {
      led_flag = RIGHT;
    }
    //下一个显示LED计算
    led_num = led_num + led_flag;
    //逻辑上圆环搭建
    if(led_num < 5) {
      led_num = 7;
    } else if(led_num > 7) {
      led_num = 5;
    }
  }
}
```


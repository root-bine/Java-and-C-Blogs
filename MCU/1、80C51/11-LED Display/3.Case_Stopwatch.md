## 1、<span style="color:brown">数码管计时器：</span>

代码实现功能：

1. 数码管**自动开始计数**，从`0 ~ 99`；
2. 按下Button：
   - 第一次Drop：数码管自动清零；
   - 第二次开始：Drop_01是暂停，Drop_02是清零；
3. MCU下电，重复上述步骤；



## 2、<span style="color:brown">工程代码：</span>

**2.1、头文件和寄存器：**

<u>引入头文件</u>：

````c
#include <reg52.h>
````

<u>定义`P4`和`XCON`</u>：

````c
sfr P4    = 0xe8;                   
sfr XICON = 0xc0;                   
sbit PX3  = XICON^7;
sbit EX3  = XICON^6;
sbit IE3  = XICON^5;
sbit IT3  = XICON^4;
sbit PX2  = XICON^3;
sbit EX2  = XICON^2;
sbit IE2  = XICON^1;
sbit IT2  = XICON^0;
````

<u>定义KEY、数码管寄存器</u>：

````c
sbit key1 = P4^3;
sbit ds_pin = P0^3;
sbit stcp_pin = P0^4;
sbit shcp_pin = P0^5;
````

**2.2、数码管功能：**

````c
void hc595_send_byte(unsigned char byte) {
	unsigned int i;
    for(i = 0; i < 8; i++) {
        if(byte & 0x80) {
            ds_pin = 1;
        } else {
            ds_pin = 0;
        }
        shcp_pin = 0;
        shcp_pin = 1;
        byte <<= 1;
    }
}
void hc595_send_data(unsigned char num, unsigned char addr) {
	hc595_send_byte(num);
	if(addr == 0) {
        hc595_send_byte(0xFE);
    } else if(addr == 1) {
        hc595_send_byte(0xFD);
    }  
    stcp_pin = 0;
    stcp_pin = 1;
}
````

**2.3、初始化INT2和Timer0：**

````c
#define TIMS (65536-9216 )
void init_int2() {
	IT2 = 1;
  	EX2 = 1;
}
void init_timer0() {
	TMOD = 0x01;
	TR0 = 1;
	TL0 = TIMS; 
	TH0 = TIMS >> 8;
	ET0 = 1;
}
````

**2.4、中断服务函数：**

使用**定时器中断**，每`10 ms`触发一次，一直累计到`count = 9900`：

````c
void timer0() interrupt 1 {
	if(count <= 9900) {		
		count ++;
	}
	TL0 = TIMS;
	TH0 = TIMS >> 8;
}
````

在INT2中断服务函数中，定义如下逻辑：

````c
void exit2() interrupt 6 {
	if(key1 == 0) {     // button按下时, 根据Flag判断button的功能
        /** MCU上电后, 第一次时"flag默认值是0", "清零count, 并更新flag值为1"
         ** 第二次, 进入else分支, 实现"暂停功能, 并更新flag值为0"
         ** 第三次, 进入if分支, 实现清零count, 并更新flag值为1
         ** ......
         **/
		if(flag == 0) { 
            count = 0;
            /** 由于else分支要实现"暂停计数"功能, 因此当重新进入if分支时:
             ** 1. 需要"开启Timer"
             ** 2. "重新填入预装载值"
             **/
			TR0 = 1;     
			TL0 = TIMS;
			TH0 = TIMS >> 8;
        } else {
			TR0 = 0;
        }
        flag = ~flag;
  }
}
````

由于**if分支**和**else分支**都会在`key == 0`时，进行**数值更新**，可简略成：`flag = ~flag`。

**2.5、main函数：**

```c
void main(){
    init_int2();
	init_timer0(); 
	EA = 1;
	while(1) {
		hc595_send_data(num[count/1000], 0);
		hc595_send_data(num[(count/100)%10], 1);
	}
}

```

